!function(C){"use strict";function n(e,t){this.options=t,this.$element=C(e),this.$container=C("<div/>",{class:"ms-container"}),this.$selectableContainer=C("<div/>",{class:"ms-selectable"}),this.$selectionContainer=C("<div/>",{class:"ms-selection"}),this.$selectableUl=C("<ul/>",{class:"ms-list",tabindex:"-1"}),this.$selectionUl=C("<ul/>",{class:"ms-list",tabindex:"-1"}),this.scrollTo=0,this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container,."+t.disabledClass+")"}n.prototype={constructor:n,init:function(){var e,t=this,s=this.$element;0===s.next(".ms-container").length&&(s.css({position:"absolute",left:"-9999px"}),s.attr("id",s.attr("id")?s.attr("id"):Math.ceil(1e3*Math.random())+"multiselect"),this.$container.attr("id","ms-"+s.attr("id")),this.$container.addClass(t.options.cssClass),s.find("option").each(function(){t.generateLisFromOption(this)}),this.$selectionUl.find(".ms-optgroup-label").hide(),t.options.selectableHeader&&t.$selectableContainer.append(t.options.selectableHeader),t.$selectableContainer.append(t.$selectableUl),t.options.selectableFooter&&t.$selectableContainer.append(t.options.selectableFooter),t.options.selectionHeader&&t.$selectionContainer.append(t.options.selectionHeader),t.$selectionContainer.append(t.$selectionUl),t.options.selectionFooter&&t.$selectionContainer.append(t.options.selectionFooter),t.$container.append(t.$selectableContainer),t.$container.append(t.$selectionContainer),s.after(t.$container),t.activeMouse(t.$selectableUl),t.activeKeyboard(t.$selectableUl),e=t.options.dblClick?"dblclick":"click",t.$selectableUl.on(e,".ms-elem-selectable",function(){t.select(C(this).data("ms-value"))}),t.$selectionUl.on(e,".ms-elem-selection",function(){t.deselect(C(this).data("ms-value"))}),t.activeMouse(t.$selectionUl),t.activeKeyboard(t.$selectionUl),s.on("focus",function(){t.$selectableUl.focus()}));var l=s.find("option:selected").map(function(){return C(this).val()}).get();t.select(l,"init"),"function"==typeof t.options.afterInit&&t.options.afterInit.call(this,this.$container)},generateLisFromOption:function(e,t,s){for(var l=this,i=l.$element,n="",o=C(e),a=0;a<e.attributes.length;a++){var c=e.attributes[a];"value"!==c.name&&"disabled"!==c.name&&(n+=c.name+'="'+c.value+'" ')}var r=C("<li "+n+"><span>"+l.escapeHTML(o.text())+"</span></li>"),d=r.clone(),h=o.val(),p=l.sanitize(h);r.data("ms-value",h).addClass("ms-elem-selectable").attr("id",p+"-selectable"),d.data("ms-value",h).addClass("ms-elem-selection").attr("id",p+"-selection").hide(),(o.prop("disabled")||i.prop("disabled"))&&(d.addClass(l.options.disabledClass),r.addClass(l.options.disabledClass));var f,u,m,b,g,v,$=o.parent("optgroup");0<$.length?(f=$.attr("label"),u=l.sanitize(f),g=l.$selectableUl.find("#optgroup-selectable-"+u),v=l.$selectionUl.find("#optgroup-selection-"+u),0===g.length&&(b='<ul class="ms-optgroup"><li class="ms-optgroup-label"><span>'+f+"</span></li></ul>",g=C(m='<li class="ms-optgroup-container"></li>'),v=C(m),g.attr("id","optgroup-selectable-"+u),v.attr("id","optgroup-selection-"+u),g.append(C(b)),v.append(C(b)),l.options.selectableOptgroup&&(g.find(".ms-optgroup-label").on("click",function(){var e=$.children(":not(:selected, :disabled)").map(function(){return C(this).val()}).get();l.select(e)}),v.find(".ms-optgroup-label").on("click",function(){var e=$.children(":selected:not(:disabled)").map(function(){return C(this).val()}).get();l.deselect(e)})),l.$selectableUl.append(g),l.$selectionUl.append(v)),t=null==t?g.find("ul").children().length:t+1,r.insertAt(t,g.children()),d.insertAt(t,v.children())):(t=null==t?l.$selectableUl.children().length:t,r.insertAt(t,l.$selectableUl),d.insertAt(t,l.$selectionUl))},addOption:function(e){var i=this;e.value&&(e=[e]),C.each(e,function(e,t){var s,l;t.value&&0===i.$element.find("option[value='"+t.value+"']").length&&(s=C('<option value="'+t.value+'">'+t.text+"</option>"),e=parseInt(void 0===t.index?i.$element.children().length:t.index),l=null==t.nested?i.$element:C("optgroup[label='"+t.nested+"']"),s.insertAt(e,l),i.generateLisFromOption(s.get(0),e,t.nested))})},escapeHTML:function(e){return C("<div>").text(e).html()},activeKeyboard:function(s){var l=this;s.on("focus",function(){C(this).addClass("ms-focus")}).on("blur",function(){C(this).removeClass("ms-focus")}).on("keydown",function(e){switch(e.which){case 40:case 38:return e.preventDefault(),e.stopPropagation(),void l.moveHighlight(C(this),38===e.which?-1:1);case 37:case 39:return e.preventDefault(),e.stopPropagation(),void l.switchList(s);case 9:if(l.$element.is("[tabindex]")){e.preventDefault();var t=parseInt(l.$element.attr("tabindex"),10),t=e.shiftKey?t-1:t+1;return void C('[tabindex="'+t+'"]').focus()}e.shiftKey&&l.$element.trigger("focus")}if(-1<C.inArray(e.which,l.options.keySelect))return e.preventDefault(),e.stopPropagation(),void l.selectHighlighted(s)})},moveHighlight:function(e,t){var s,l,i,n,o=e.find(this.elemsSelector),a=o.filter(".ms-hover"),c=null,r=o.first().outerHeight(),d=e.height();this.$container.prop("id");o.removeClass("ms-hover"),1===t?0===(c=a.nextAll(this.elemsSelector).first()).length&&(c=(l=a.parent()).hasClass("ms-optgroup")&&0<(s=l.parent().next(":visible")).length?s.find(this.elemsSelector).first():o.first()):-1===t&&0===(c=a.prevAll(this.elemsSelector).first()).length&&(c=(l=a.parent()).hasClass("ms-optgroup")&&0<(i=l.parent().prev(":visible")).length?i.find(this.elemsSelector).last():o.last()),0<c.length&&(c.addClass("ms-hover"),n=e.scrollTop()+c.position().top-d/2+r/2,e.scrollTop(n))},selectHighlighted:function(e){var t=e.find(this.elemsSelector),s=t.filter(".ms-hover").first();0<s.length&&(e.parent().hasClass("ms-selectable")?this.select(s.data("ms-value")):this.deselect(s.data("ms-value")),t.removeClass("ms-hover"))},switchList:function(e){e.blur(),this.$container.find(this.elemsSelector).removeClass("ms-hover"),e.parent().hasClass("ms-selectable")?this.$selectionUl.focus():this.$selectableUl.focus()},activeMouse:function(e){var t=this;C("body").on("mouseenter",t.elemsSelector,function(){C(this).parents(".ms-container").find(t.elemsSelector).removeClass("ms-hover"),C(this).addClass("ms-hover")})},refresh:function(){this.destroy(),this.$element.multiSelect(this.options)},destroy:function(){C("#ms-"+this.$element.attr("id")).remove(),this.$element.css("position","").css("left",""),this.$element.removeData("multiselect")},select:function(e,t){"string"==typeof e&&(e=[e]);var s,l,i=this,n=this.$element,o=C.map(e,function(e){return i.sanitize(e)}),a=this.$selectableUl.find("#"+o.join("-selectable, #")+"-selectable").filter(":not(."+i.options.disabledClass+")"),c=this.$selectionUl.find("#"+o.join("-selection, #")+"-selection").filter(":not(."+i.options.disabledClass+")"),r=n.find("option:not(:disabled)").filter(function(){return-1<C.inArray(this.value,e)});"init"===t&&(a=this.$selectableUl.find("#"+o.join("-selectable, #")+"-selectable"),c=this.$selectionUl.find("#"+o.join("-selection, #")+"-selection")),0<a.length&&(a.addClass("ms-selected").hide(),c.addClass("ms-selected").show(),r.prop("selected",!0),i.$container.find(i.elemsSelector).removeClass("ms-hover"),0<(s=i.$selectableUl.children(".ms-optgroup-container")).length?(s.each(function(){var e=C(this).find(".ms-elem-selectable");e.length===e.filter(".ms-selected").length&&C(this).find(".ms-optgroup-label").hide()}),i.$selectionUl.children(".ms-optgroup-container").each(function(){0<C(this).find(".ms-elem-selection").filter(".ms-selected").length&&C(this).find(".ms-optgroup-label").show()})):!i.options.keepOrder||"init"===t||1<(l=i.$selectionUl.find(".ms-selected")).length&&l.last().get(0)!=c.get(0)&&c.insertAfter(l.last()),"init"!==t&&(n.trigger("change"),"function"==typeof i.options.afterSelect&&i.options.afterSelect.call(this,e)))},deselect:function(e){"string"==typeof e&&(e=[e]);var t,s=this,l=this.$element,i=C.map(e,function(e){return s.sanitize(e)}),n=this.$selectableUl.find("#"+i.join("-selectable, #")+"-selectable"),o=this.$selectionUl.find("#"+i.join("-selection, #")+"-selection").filter(".ms-selected").filter(":not(."+s.options.disabledClass+")"),a=l.find("option").filter(function(){return-1<C.inArray(this.value,e)});0<o.length&&(n.removeClass("ms-selected").show(),o.removeClass("ms-selected").hide(),a.prop("selected",!1),s.$container.find(s.elemsSelector).removeClass("ms-hover"),0<(t=s.$selectableUl.children(".ms-optgroup-container")).length&&(t.each(function(){0<C(this).find(".ms-elem-selectable").filter(":not(.ms-selected)").length&&C(this).find(".ms-optgroup-label").show()}),s.$selectionUl.children(".ms-optgroup-container").each(function(){0===C(this).find(".ms-elem-selection").filter(".ms-selected").length&&C(this).find(".ms-optgroup-label").hide()})),l.trigger("change"),"function"==typeof s.options.afterDeselect&&s.options.afterDeselect.call(this,e))},select_all:function(){var e,t=this.$element,s=t.val();t.find('option:not(":disabled")').prop("selected",!0),this.$selectableUl.find(".ms-elem-selectable").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").hide(),this.$selectionUl.find(".ms-optgroup-label").show(),this.$selectableUl.find(".ms-optgroup-label").hide(),this.$selectionUl.find(".ms-elem-selection").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").show(),this.$selectionUl.focus(),t.trigger("change"),"function"==typeof this.options.afterSelect&&(e=C.grep(t.val(),function(e){return C.inArray(e,s)<0}),this.options.afterSelect.call(this,e))},deselect_all:function(){var e=this.$element,t=e.val();e.find("option").prop("selected",!1),this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show(),this.$selectionUl.find(".ms-optgroup-label").hide(),this.$selectableUl.find(".ms-optgroup-label").show(),this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide(),this.$selectableUl.focus(),e.trigger("change"),"function"==typeof this.options.afterDeselect&&this.options.afterDeselect.call(this,t)},sanitize:function(e){var t=0;if(0==e.length)return t;for(var s=0,l=e.length;s<l;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t}},C.fn.multiSelect=function(){var l=arguments[0],i=arguments;return this.each(function(){var e=C(this),t=e.data("multiselect"),s=C.extend({},C.fn.multiSelect.defaults,e.data(),"object"==typeof l&&l);t||e.data("multiselect",t=new n(this,s)),"string"==typeof l?t[l](i[1]):t.init()})},C.fn.multiSelect.defaults={keySelect:[32],selectableOptgroup:!1,disabledClass:"disabled",dblClick:!1,keepOrder:!1,cssClass:""},C.fn.multiSelect.Constructor=n,C.fn.insertAt=function(e,t){return this.each(function(){0===e?t.prepend(this):t.children().eq(e-1).after(this)})}}(window.jQuery);